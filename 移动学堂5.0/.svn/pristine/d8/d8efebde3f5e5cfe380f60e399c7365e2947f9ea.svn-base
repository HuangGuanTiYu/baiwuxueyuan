//
//  StudyCircleFrame.m
//  MoveSchool
//
//  Created by edz on 2017/5/8.
//
//

#import "StudyCircleFrame.h"
#import "StudyCircleModel.h"
#import "NSAttributedString+Extension.h"
#import "NSString+Extension.h"
#import "NSDataEx.h"
#import "StudyAttachs.h"
#import "StudyReply.h"
#import "EmotionTool.h"
#import "NSDate+Extension.h"
#import "StudyPraises.h"
#import "MJExtension.h"

//å›¾ç‰‡é—´è·
#define imageSpacint 4

@implementation StudyCircleFrame

MJCodingImplementation

- (void)setStudyCircleModel:(StudyCircleModel *)studyCircleModel
{
    _studyCircleModel = studyCircleModel;
    
    _headerFrame = CGRectMake(mainSpacing, mainSpacing, 44, 44);
    
    // æ˜µç§°X
    CGFloat namex = CGRectGetMaxX(_headerFrame) + mainSpacing;
    CGSize size = [studyCircleModel.nickname returnStringRect:studyCircleModel.nickname size:CGSizeMake(SCREEN_WIDTH - namex - mainSpacing, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f30]];
    _nameFrame = CGRectMake(namex, mainSpacing, size.width > SCREEN_WIDTH - namex - mainSpacing ? SCREEN_WIDTH - namex - mainSpacing : size.width, 20);
    
    //ç­‰çº§
    NSString *lv = [NSString stringWithFormat:@"LV%ld",(long)studyCircleModel.userlv];
    CGSize lvSize = [lv returnStringRect:lv size:CGSizeMake(SCREEN_WIDTH, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f20]];
    _vipFrame = CGRectMake(CGRectGetMaxX(_headerFrame) - lvSize.width - 6, CGRectGetMaxY(_headerFrame) - 12, lvSize.width + 6, 12);
    
    //å›¾ç‰‡Y
    CGFloat imageY = CGRectGetMaxY(_nameFrame) + mainSpacing;
    
    //å†…å®¹
    if (studyCircleModel.content.length > 0) {
        
        CGFloat contentW = SCREEN_WIDTH - namex - mainSpacing;
        
        NSMutableAttributedString *attributedString = [[NSMutableAttributedString alloc] initWithString:[self base64DecodeString:studyCircleModel.content]];
        
        NSMutableParagraphStyle *paragraphStyle = [[NSMutableParagraphStyle alloc] init];
        [paragraphStyle setLineSpacing:LineSpacing];
        [attributedString addAttribute:NSParagraphStyleAttributeName value:paragraphStyle range:NSMakeRange(0, [[self base64DecodeString:studyCircleModel.content] length])];
        
        CGSize contentSize = [attributedString returnAttributedStringRect:attributedString size:CGSizeMake(contentW, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]];

        _contentFrame = CGRectMake(namex, CGRectGetMaxY(_nameFrame) + 4, contentW, contentSize.height);
        
        //éœ€è¦ å±•ç¤ºå…¨éƒ¨å†…å®¹
        if (!self.needShowAllContent) {
            UILabel *contentLabel = [[UILabel alloc] initWithFrame:_contentFrame];
            contentLabel.attributedText = attributedString;
            NSNumber *count = @((contentLabel.size.height + LineSpacing) / (contentLabel.font.lineHeight + LineSpacing));
            
            if ([count intValue] > 6) {
                _isMoreThanSix = YES;
                
                _contentFrame = CGRectMake(namex, CGRectGetMaxY(_nameFrame) + 4, contentW, 6 * contentLabel.font.lineHeight + LineSpacing * 5);
                
                _allFrame = CGRectMake(namex, CGRectGetMaxY(_contentFrame) + mainSpacing, [@"å…¨æ–‡" returnStringRect:@"å…¨æ–‡" size:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]].width, 20);
                
                imageY = CGRectGetMaxY(_allFrame) + mainSpacing;
            }else
            {
                _isMoreThanSix = NO;
                _allFrame = CGRectZero;
                imageY = CGRectGetMaxY(_contentFrame) + mainSpacing;
            }
        }else
        {
            _isMoreThanSix = YES;
            
            _allFrame = CGRectMake(namex, CGRectGetMaxY(_contentFrame) + mainSpacing, [@"å…¨æ–‡" returnStringRect:@"å…¨æ–‡" size:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]].width, 20);
            
            imageY = CGRectGetMaxY(_allFrame) + mainSpacing;
        }
    }
    
    //æ—¶é—´
    CGFloat timeY = imageY;
    
    //å›¾ç‰‡
    if (studyCircleModel.attachs.count > 0) {
        //è®¡ç®— å›¾ç‰‡å®½é«˜
        CGFloat imageWH = ((SCREEN_WIDTH - namex * 1.5) - 2 * imageSpacint) / 3;
        
        //9å¼ å›¾ç‰‡æ—¶çš„å®½é«˜
        CGFloat nightWH = SCREEN_WIDTH - namex * 1.5;
        
        //åªæœ‰ä¸€å¼ å›¾ç‰‡ ç‰¹æ®Šå¤„ç†
        if (studyCircleModel.attachs.count == 1) {
            _imagesFrame = CGRectMake(namex, imageY, nightWH * 0.5 , 2 * imageWH + imageSpacint);
            
            _oneImageFrame = CGRectMake(0, 0, _imagesFrame.size.width, _imagesFrame.size.height);
        }else if(studyCircleModel.attachs.count != 4)
        {
            int count = (int)studyCircleModel.attachs.count;
            CGFloat imageH = 0;
            
            if (count < 4) { // ä¸€è¡Œ
                imageH = imageWH;
            }else if(count < 7) // äºŒè¡Œ
            {
                imageH = imageWH * 2 + imageSpacint;
            }else //ä¸‰è¡Œ
            {
                imageH = imageWH * 3 + 2 * imageSpacint;
            }
            
            _imagesFrame = CGRectMake(namex, imageY, count > 2 ? nightWH : imageWH * 2 + imageSpacint, imageH);
            
            _oneImageFrame = CGRectMake(0, 0, imageWH, imageWH);
        }else //4å¼ å›¾ç‰‡ ç‰¹æ®Šå¤„ç†
        {
            _imagesFrame = CGRectMake(namex, imageY, imageWH * 2 + imageSpacint, imageWH * 2 + imageSpacint);
            _oneImageFrame = CGRectMake(0, 0, imageWH, imageWH);
        }
        
        timeY = CGRectGetMaxY(_imagesFrame) + mainSpacing;
    }
    
    NSString *time = [[NSDate getDateByString:studyCircleModel.indate] timeIntervalDescription];
    
    CGFloat newTimeY = timeY;
    
    if (studyCircleModel.type == 3 || studyCircleModel.type == [shalongType intValue] || studyCircleModel.type == [courseType intValue] ) {
        if (studyCircleModel.attachs.count > 0) {
            StudyAttachs *attach = [studyCircleModel.attachs firstObject];
            _describeFrame = CGRectMake(namex, timeY, [attach.title returnStringRect:attach.title size:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]].width + mainSpacing, 20);
            newTimeY = CGRectGetMaxY(_describeFrame) + mainSpacing;
        }else
        {
            _describeFrame = CGRectZero;
        }
    }else
    {
        _describeFrame = CGRectZero;
    }
    
    _timeFrame = CGRectMake(namex, newTimeY, [time returnStringRect:time size:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]].width + mainSpacing, 20);
    
    //è‡ªå·±å‘å¸ƒ
    if (studyCircleModel.isself == 1) {
        CGSize size = [@"åˆ é™¤" returnStringRect:@"åˆ é™¤" size:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]];
        _deleteFrame = CGRectMake(CGRectGetMaxX(_timeFrame), _timeFrame.origin.y, size.width, size.height);
    }else
    {
        _deleteFrame = CGRectZero;
    }
    
    CGFloat commentButtonY = 0;
    if (14 - _timeFrame.size.height > 0) {
        commentButtonY = _timeFrame.origin.y - (14 - _timeFrame.size.height) * 0.5;
    }else
    {
        commentButtonY = _timeFrame.origin.y + (_timeFrame.size.height - 14) * 0.5;
    }
    
    _commentButtonFrame = CGRectMake(SCREEN_WIDTH - 19 - mainSpacing, commentButtonY, 14, 14);
    
    _commentAlertFrame = CGRectMake(_commentButtonFrame.origin.x, commentButtonY - _commentButtonFrame.size.height * 0.7, 0, _commentButtonFrame.size.height * 2.5);
    
    _alertGoodFrame = CGRectMake(0, 0, ReplyWidth * 0.5, _commentAlertFrame.size.height);
    
    _alertReplyFrame = CGRectMake(ReplyWidth * 0.5, 0, ReplyWidth * 0.5, _commentAlertFrame.size.height);
    
    _alertSepaViewFrame = CGRectMake(ReplyWidth * 0.5 - 0.25, _commentAlertFrame.size.height * 0.4 * 0.5, 0.5, _commentAlertFrame.size.height * 0.6);
    
    //èµğŸ‘
    if (studyCircleModel.praises.count > 0) {
        NSMutableString *praiseContent = [NSMutableString string];
        for (StudyPraises *praise in studyCircleModel.praises) {
            [praiseContent appendString:[NSString stringWithFormat:@"%@ï¼Œ",praise.nickname]];
        }
        
        if ([praiseContent containsString:@"ï¼Œ"]) {
            praiseContent = (NSMutableString *)[praiseContent substringToIndex:praiseContent.length - 1];
        }
        
        NSMutableAttributedString *praiseAttribute = [[NSMutableAttributedString alloc] initWithString:praiseContent];

        //å›¾ç‰‡åç§°
        NSTextAttachment *textAttach = [[NSTextAttachment alloc] init];
        textAttach.bounds = CGRectMake(0, -2, 14, 14);
        textAttach.image = [UIImage imageNamed:@"frends_subpraise_h"];
        
        //æŠŠé™„ä»¶è½¬æ¢æˆå¯å˜å­—ç¬¦ä¸²ï¼Œç”¨äºæ›¿æ¢æ‰æºå­—ç¬¦ä¸²ä¸­çš„è¡¨æƒ…æ–‡å­—
        NSAttributedString *imageStr = [NSAttributedString attributedStringWithAttachment:textAttach];
        
        [praiseAttribute insertAttributedString:imageStr atIndex:0];
        
        self.praiseAttribute = praiseAttribute;
        
        CGSize size = [praiseAttribute returnAttributedStringRect:praiseAttribute size:CGSizeMake(SCREEN_WIDTH - mainSpacing - namex, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]];
        _praiseListFrame = CGRectMake(namex + 5, CGRectGetMaxY(_timeFrame) + 1.5 * mainSpacing + mainSpacing * 0.5, SCREEN_WIDTH - mainSpacing - namex - 5, size.height);
        
        _cellHeight = CGRectGetMaxY(_praiseListFrame) + mainSpacing;

    }else
    {
        _praiseListFrame = CGRectZero;
        _cellHeight = CGRectGetMaxY(_timeFrame) + mainSpacing;
    }

    //è¯„è®º
    if (studyCircleModel.replys.count > 0) {
        
        self.commentsF = [NSMutableArray array];
        
        CGFloat replyLabelX = namex;
        
        for (int i = 0; i < [studyCircleModel.replys count]; i++) {
            StudyReply *reply = studyCircleModel.replys[i];
            
            //å†…å®¹
            NSString *content = @"";
            
            //æœ‰å›å¤
            if (reply.touserid > 0) {
                content = [NSString stringWithFormat:@"%@å›å¤%@ï¼š%@",reply.nickname,reply.tonickname,[self base64DecodeString:reply.content]];
            }else
            {
                content = [NSString stringWithFormat:@"%@ï¼š%@",reply.nickname,[self base64DecodeString:reply.content]];
            }
            
            //æ­£åˆ™è¡¨è¾¾å¼
            NSString * pattern = @"\\[[a-zA-Z0-9\\u4e00-\\u9fa5]+\\]";
            NSError *error = nil;
            NSRegularExpression * re = [NSRegularExpression regularExpressionWithPattern:pattern options:NSRegularExpressionCaseInsensitive error:&error];
            
            //é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…å­—ç¬¦ä¸²
            NSArray *resultArray = [re matchesInString:content options:0 range:NSMakeRange(0, content.length)];
            
            //ç”¨æ¥å­˜æ”¾å­—å…¸ï¼Œå­—å…¸ä¸­å­˜å‚¨çš„æ˜¯å›¾ç‰‡å’Œå›¾ç‰‡å¯¹åº”çš„ä½ç½®
            NSMutableArray *imageArray = [NSMutableArray arrayWithCapacity:resultArray.count];
            
            for (NSInteger i = 0; i  < [resultArray count]; ++i) {
                NSTextCheckingResult *result = resultArray[i];
                NSRange range =  [result range];
                
                NSMutableDictionary *imageDic = [NSMutableDictionary dictionaryWithCapacity:2];
                NSString *subStr = [content substringWithRange:range];
                
                //å›¾ç‰‡åç§°
                NSString *imageName = [EmotionTool imageNameWithString:subStr];
                
                NSTextAttachment *textAttach = [[NSTextAttachment alloc] init];
                textAttach.bounds = CGRectMake(0, -2, 14, 14);
                textAttach.image = [UIImage imageNamed:imageName];
                
                //æŠŠé™„ä»¶è½¬æ¢æˆå¯å˜å­—ç¬¦ä¸²ï¼Œç”¨äºæ›¿æ¢æ‰æºå­—ç¬¦ä¸²ä¸­çš„è¡¨æƒ…æ–‡å­—
                NSAttributedString *imageStr = [NSAttributedString attributedStringWithAttachment:textAttach];
                
                [imageDic setObject:imageStr forKey:@"image"];
                [imageDic setObject:[NSValue valueWithRange:range] forKey:@"range"];
                [imageArray addObject:imageDic];
            }
            
            NSMutableAttributedString *attributeString = [[NSMutableAttributedString alloc] initWithString:content];
            
            for (NSInteger i = [imageArray count]-1; i >= 0; i--) {
                NSDictionary *dic = imageArray[i];
                NSRange range = [dic[@"range"] rangeValue];
                [attributeString replaceCharactersInRange:range withAttributedString:dic[@"image"]];
            }
            
            reply.replyString = attributeString;
                        
            CGSize replyLabelSize = [attributeString returnAttributedStringRect:attributeString size:CGSizeMake(SCREEN_WIDTH - mainSpacing - namex, CGFLOAT_MAX) font:[UIFont systemFontOfSize:ys_f24]];
            
            CGFloat replyLabelY = _cellHeight;
            CGFloat replyLabelWidth = replyLabelSize.width;
            CGFloat replyLabelHeight = replyLabelSize.height + 5;
            _cellHeight += replyLabelHeight;
            CGRect replyF = CGRectMake(replyLabelX, replyLabelY, replyLabelWidth, replyLabelHeight);
            [self.commentsF addObject:[NSValue valueWithCGRect:replyF]];
        }
        
        //è¯„è®ºçš„èƒŒæ™¯
        _cellHeight = CGRectGetMaxY([(NSValue *)[self.commentsF lastObject] CGRectValue]) + mainSpacing + 1;
        
        CGFloat replyBackgroundWidth = SCREEN_WIDTH - mainSpacing - namex;
        CGFloat replyBackgroundHeight = self.cellHeight - mainSpacing * 2 - CGRectGetMaxY(_timeFrame);

        //æœ‰èµ æœ‰è¯„è®º
        if (studyCircleModel.praises.count > 0) {
            _commentViewBjFrame = CGRectMake(namex, CGRectGetMaxY(_timeFrame) + 5, replyBackgroundWidth, replyBackgroundHeight + 3);

            _commentViewFrame = CGRectMake(namex, CGRectGetMaxY(_praiseListFrame) + mainSpacing * 0.5 + 2, replyBackgroundWidth, replyBackgroundHeight);
        }else //åªæœ‰è¯„è®º
        {
            _commentViewBjFrame = CGRectMake(namex, CGRectGetMaxY(_timeFrame) + 5, replyBackgroundWidth, replyBackgroundHeight + mainSpacing+ 1);

            _commentViewFrame = CGRectMake(namex, CGRectGetMaxY(_timeFrame) + 1.5 * mainSpacing, replyBackgroundWidth, replyBackgroundHeight);
            
            _cellHeight = _cellHeight + mainSpacing * 0.5;

        }
    }else if(studyCircleModel.praises.count > 0) //åªæœ‰èµ
    {
        CGFloat replyBackgroundWidth = SCREEN_WIDTH - mainSpacing - namex;
        
        _commentViewBjFrame = CGRectMake(namex, CGRectGetMaxY(_timeFrame) + 5, replyBackgroundWidth, _praiseListFrame.size.height + mainSpacing * 2 + 1);
        
        _commentViewFrame = CGRectZero;
        
        _cellHeight = _cellHeight + mainSpacing * 0.5;
        
    }else
    {
        _commentViewBjFrame = CGRectZero;
        _commentViewFrame = CGRectZero;
    }

    _cellSepaViewFrame = CGRectMake(0, _cellHeight - 0.5, SCREEN_WIDTH, 0.5);
}

-(NSString *)base64DecodeString:(NSString *)string

{
    //1.å°†base64ç¼–ç åçš„å­—ç¬¦ä¸²ã€è§£ç ã€ä¸ºäºŒè¿›åˆ¶æ•°æ®
    NSData *data = [NSData dataWithBase64EncodedString:string];
    
    //2.æŠŠäºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿”å›
    return [[NSString alloc]initWithData:data encoding:NSUTF8StringEncoding];
}

- (void) reloadData
{
    [self setStudyCircleModel:self.studyCircleModel];
}

@end
